name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  # https://doc.rust-lang.org/cargo/reference/profiles.html#release
  RUSTFLAGS: -Coverflow-checks=y -Cdebug-assertions=y
  # https://doc.rust-lang.org/cargo/reference/profiles.html#incremental
  CARGO_INCREMENTAL: 1
  # https://nexte.st/book/pre-built-binaries.html#using-nextest-in-github-actions
  CARGO_TERM_COLOR: always

jobs:
  run_checks:
    strategy:
      matrix:
        rust_toolchain_version: [1.67, 1.68, 1.69]
        # Follow ocamlgen-test.opam requirements
        ocaml_version: [4.12, 4.13, 4.14, 5.0.0]

    runs-on: ubuntu-latest
    name: Run some basic checks and tests
    steps:
      #
      # Setup
      #

      - name: Checkout PR
        uses: actions/checkout@v2

      - name: Set up cargo/rust ${{ matrix.rust_toolchain_version }}
        uses: actions-rs/toolchain@v1
        with:
          # Using default to get rust-docs, rustfmt and clippy
          # Doc: https://rust-lang.github.io/rustup/concepts/profiles.html
          profile: default
          toolchain: ${{ matrix.rust_toolchain_version }}
          # Override the default toolchain. This is required in the case of
          # bugfixing release of rust.
          override: true

      - name: Setup OCaml ${{ matrix.ocaml_version }} (because of ocaml-gen)
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: ${{ matrix.ocaml_version }}
          # https://github.com/ocaml/setup-ocaml/issues/211#issuecomment-1058882386
          # disable-cache: true

      #
      # Coding guidelines
      #

      - name: Enforce formating
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: -- --check

      - name: Lint (clippy)
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --all-features -- -D warnings

      #
      # OCaml (tests)
      #

      - name: Build and run tests
        run: |
          opam install . --deps-only --with-test
          eval $(opam env)
          dune build
          dune runtest

      - name: Check that up-to-date bindings are checked in
        run: |
          git diff --exit-code
